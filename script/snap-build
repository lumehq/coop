#!/usr/bin/env bash
set -euxo pipefail

if [ "$#" -ne 1 ]; then
  echo "Usage: $0 <release_version>"
  exit 1
fi

# Debug: Print current directory and input file
echo "Current directory: $(pwd)"
ls -la crates/coop/resources/snap/snapcraft.yaml.in || { echo "Input file missing!"; exit 1; }

# Ensure output directory exists
mkdir -p snap

# Debug: Print substituted content
echo "Substituted snapcraft.yaml:"
RELEASE_VERSION="$1" envsubst < crates/coop/resources/snap/snapcraft.yaml.in

# Generate snapcraft.yaml
RELEASE_VERSION="$1" envsubst < crates/coop/resources/snap/snapcraft.yaml.in > snap/snapcraft.yaml || { echo "Failed to generate snapcraft.yaml"; exit 1; }

# Debug: Verify the file was created
ls -la snap/snapcraft.yaml || { echo "Output file missing!"; exit 1; }

# Build the snap
snapcraft --destructive-mode
